<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Code Collaboration</title>
  
  <!-- Google Fonts: Roboto Mono -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">

  <!-- Socket.io client script -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- CodeMirror Core CSS/JS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/codemirror.min.js"></script>
  
  <!-- Language modes: JavaScript, Python, C (via clike) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/mode/clike/clike.min.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/theme/monokai.min.css" />

  <!-- CodeMirror Addons for Autocompletion -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/hint/show-hint.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/hint/show-hint.min.js"></script>

  <!-- CodeMirror Addons for Linting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/lint/lint.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/lint/lint.min.js"></script>
  <!-- JSHint for JavaScript linting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.4/jshint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.0/addon/lint/javascript-lint.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <style>
    /* Global Styles using black & white and Roboto Mono for text */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto Mono', monospace;
      background: #000;
      color: #fff;
      height: 100vh;
      overflow: hidden;
    }
    /* Login Page Styles */
    #loginPage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      transition: opacity 0.5s ease;
    }
    #loginPage.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #loginPage h1 {
      margin-bottom: 20px;
      font-weight: normal;
    }
    #loginPage input {
      padding: 10px;
      width: 250px;
      border-radius: 4px;
      border: 1px solid #444;
      outline: none;
      margin-bottom: 15px;
      font-size: 16px;
      background: #000;
      color: #fff;
    }
    #loginPage button {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 16px;
      transition: background 0.3s;
    }
    #loginPage button:hover {
      background: #555;
    }
    /* Main Interface Styles */
    #mainPage {
      display: none;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: row;
      gap: 10px;
    }
    #mainPage.visible {
      display: flex;
    }
    /* Editor Container */
    #editorContainer {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(255,255,255,0.3);
      background: #111;
      position: relative;
    }
    /* Toolbar for Language selection, AI, Run Code, and Send Code */
    #editorToolbar {
      padding: 5px;
      background: #222;
      display: flex;
      gap: 10px;
      align-items: center;
      position: relative;
    }
    #editorToolbar button,
    #editorToolbar select {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      background: #333;
      color: #fff;
      transition: background 0.3s;
    }
    #editorToolbar button:hover,
    #editorToolbar select:hover {
      background: #444;
    }
    /* NEW: Styles for the Send Code container */
    #sendCodeContainer {
      position: absolute;
      top: 40px;
      right: 10px;
      background: #222;
      border: 1px solid #444;
      padding: 10px;
      border-radius: 4px;
      display: none;
      z-index: 20;
    }
    #sendCodeContainer select {
      width: 200px;
      height: 100px;
      background: #111;
      color: #fff;
      border: 1px solid #444;
    }
    #sendCodeContainer button {
      margin-top: 10px;
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }
    #sendCodeContainer button:hover {
      background: #444;
    }
    /* Input Container for runtime inputs */
    #inputContainer {
      padding: 5px;
      background: #222;
    }
    #inputField {
      width: 100%;
      height: 50px;
      background: #111;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 5px;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
    }
    /* Tab Header for switching between Code, Output, and Received Code */
    #tabHeader {
      display: flex;
      border-bottom: 1px solid #444;
    }
    #tabHeader button {
      flex: 1;
      padding: 10px;
      background: #222;
      border: none;
      color: #fff;
      font-family: 'Roboto Mono', monospace;
      cursor: pointer;
      transition: background 0.3s;
    }
    #tabHeader button.active {
      background: #333;
      color: #fff;
    }
    /* Tab Content */
    #tabContent {
      position: relative;
      flex: 1;
      overflow: hidden;
    }
    #codeTab, #outputTab, #receivedCodeTab {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    /* CodeMirror Editor Styles Override */
    .CodeMirror {
      height: 100% !important;
      font-size: 16px;
      background: #111;
      font-family: Consolas, "Courier New", monospace;
    }
    .CodeMirror-lines {
      padding: 10px 0;
    }
    /* Output Section Styles */
    #outputSection {
      padding: 10px;
      background: #000;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      overflow-y: auto;
      height: 100%;
    }
    /* Received Code Tab Styles */
    #receivedCodeHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      background: #222;
      position: relative;
    }
    #receivedCodeContent {
      background: #111;
      padding: 10px;
      border-radius: 4px;
      overflow: auto;
      height: calc(100% - 40px);
    }
    /* Style for the Copy Button - matching the theme */
    #copyReceivedCodeButton {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      background: #333;
      color: #fff;
      transition: background 0.3s;
    }
    #copyReceivedCodeButton:hover {
      background: #444;
    }
    /* Style for the Copy Notification */
    .copy-notification {
      position: absolute;
      top: 10px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.5s ease;
      pointer-events: none;
    }
    /* Sidebar (User List + Chat) */
    #sidebar {
      width: 350px;
      min-width: 300px;
      background: #000;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(255,255,255,0.3);
      display: flex;
      flex-direction: column;
    }
    #sidebar h3 {
      margin: 10px 0 5px 0;
      font-weight: normal;
    }
    #users {
      font-size: 14px;
      list-style: none;
      padding: 0;
      margin: 0 0 10px 0;
    }
    #users li {
      margin: 2px 0;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 4px;
      color: #fff;
    }
    #chat p {
      margin: 5px 0;
    }
    #messageContainer {
      display: flex;
      margin-top: 10px;
    }
    #messageInput {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #444;
      outline: none;
      margin-right: 8px;
      color: #000;
      background: #fff;
    }
    #messageContainer button {
      padding: 10px 16px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 14px;
      transition: background 0.3s;
    }
    #messageContainer button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div id="loginPage">
    <h1>Live Code Editor</h1>
    <input type="text" id="usernameInput" placeholder="Enter your name" />
    <button onclick="join()">Join</button>
  </div>

  <!-- Main Application -->
  <div id="mainPage">
    <!-- Left Side: Editor Container with Tabs -->
    <div id="editorContainer">
      <!-- Toolbar with Language selection, AI Suggestion, Code Correction, Run Code, and Send Code buttons -->
      <div id="editorToolbar">
        <select id="languageSelect">
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="c">C</option>
          <option value="csharp">C#</option>
          <option value="java">Java</option>
          <option value="swift">Swift</option>
          <option value="cpp">C++</option>
        </select>
        <button id="aiSuggestionButton">Get AI Suggestion</button>
        <button id="aiCorrectionButton">Code Correction</button>
        <button id="runCodeButton">Run Code</button>
        <button id="sendCodeButton">Send Code</button>
        <!-- Container for selecting recipients -->
        <div id="sendCodeContainer">
          <!-- Added size attribute for multiple selections -->
          <select id="sendUserSelect" multiple size="5"></select>
          <button id="confirmSendCodeButton">Send</button>
        </div>
      </div>
      
      <!-- Input Field for Runtime Inputs -->
      <div id="inputContainer">
        <textarea id="inputField" placeholder="Enter input data here"></textarea>
      </div>
      
      <!-- Tab Header -->
      <div id="tabHeader">
        <button id="tabCode" class="active">Code</button>
        <button id="tabOutput">Output</button>
        <button id="tabReceivedCode">Received Code</button>
      </div>
      <!-- Tab Content -->
      <div id="tabContent">
        <div id="codeTab">
          <textarea id="editor"></textarea>
        </div>
        <div id="outputTab" style="display: none;">
          <pre id="outputSection"></pre>
        </div>
        <div id="receivedCodeTab" style="display: none;">
          <div id="receivedCodeHeader">
            <span id="receivedCodeSender"></span>
            <button id="copyReceivedCodeButton">Copy</button>
            <span id="copyNotification" class="copy-notification">Copied!</span>
          </div>
          <pre id="receivedCodeContent"></pre>
        </div>
      </div>
    </div>
    <!-- Right Side: Sidebar (User List & Chat) -->
    <div id="sidebar">
      <h3>Online Users</h3>
      <ul id="users"></ul>
      <h3>Chat</h3>
      <div id="chat"></div>
      <div id="messageContainer">
        <input id="messageInput" type="text" placeholder="Type a message" />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Socket.IO
    const socket = io();
    let username = "";

    // Called when user clicks "Join"
    function join() {
      username = document.getElementById("usernameInput").value.trim();
      if (username) {
        socket.emit("setUsername", username);
        document.getElementById("loginPage").classList.add("hidden");
        setTimeout(() => {
          document.getElementById("loginPage").style.display = "none";
          document.getElementById("mainPage").classList.add("visible");
        }, 500);
      }
    }

    // Initialize CodeMirror editor with auto-indentation
    const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
      mode: "javascript",
      theme: "monokai",
      lineNumbers: true,
      gutters: ["CodeMirror-lint-markers"],
      lint: true,
      smartIndent: true,
      indentUnit: 4,
      indentWithTabs: true
    });

    // Update CodeMirror mode when language selection changes
    const languageSelect = document.getElementById("languageSelect");
    languageSelect.addEventListener("change", function() {
      const lang = languageSelect.value;
      if (lang === "javascript") {
        editor.setOption("mode", "javascript");
      } else if (lang === "python") {
        editor.setOption("mode", "python");
      } else if (lang === "c") {
        editor.setOption("mode", "text/x-csrc");
      } else if (lang === "csharp") {
        editor.setOption("mode", "text/x-csharp");
      } else if (lang === "java") {
        editor.setOption("mode", "text/x-java");
      } else if (lang === "swift") {
        editor.setOption("mode", "text/x-swift");
      } else if (lang === "cpp") {
        editor.setOption("mode", "text/x-c++src");
      }
    });

    // AI Suggestion button click
    document.getElementById("aiSuggestionButton").addEventListener("click", function() {
      const code = editor.getValue();
      const language = languageSelect.value;
      socket.emit("aiSuggestion", { code, language });
    });

    // Code Correction button click
    document.getElementById("aiCorrectionButton").addEventListener("click", function() {
      const code = editor.getValue();
      const language = languageSelect.value;
      socket.emit("aiCorrection", { code, language });
    });

    // Run Code button click with input support
    document.getElementById("runCodeButton").addEventListener("click", function() {
      const code = editor.getValue();
      const language = languageSelect.value;
      const input = document.getElementById("inputField").value;
      socket.emit("runCode", { code, language, input });
    });

    // Toggle the display of the Send Code container
    document.getElementById("sendCodeButton").addEventListener("click", function() {
      const container = document.getElementById("sendCodeContainer");
      container.style.display = (container.style.display === "none" || container.style.display === "") ? "block" : "none";
    });

    // When the confirm button is clicked, send the current code to selected recipients
    document.getElementById("confirmSendCodeButton").addEventListener("click", function() {
      const selectElem = document.getElementById("sendUserSelect");
      const selectedOptions = Array.from(selectElem.selectedOptions);
      const recipients = selectedOptions.map(option => option.value);
      if (recipients.length === 0) {
        alert("Please select at least one user to send the code to.");
        return;
      }
      const code = editor.getValue();
      socket.emit("sendCode", { code, recipients });
      // Hide the send code container after sending
      document.getElementById("sendCodeContainer").style.display = "none";
    });

    // Update the multi-select options with the current online users (excluding yourself)
    function updateSendUserSelect(users) {
      const select = document.getElementById("sendUserSelect");
      select.innerHTML = "";
      users.forEach(user => {
        if (user !== username) {
          const option = document.createElement("option");
          option.value = user;
          option.textContent = user;
          select.appendChild(option);
        }
      });
    }

    // Update user list and send code dropdown
    socket.on("userList", function(users) {
      const userList = document.getElementById("users");
      userList.innerHTML = "";
      users.forEach(function(user) {
        const li = document.createElement("li");
        if (user === username) {
          li.textContent = `You: ${user}`;
          li.style.color = "#00ff00"; // Green color for yourself
        } else {
          li.textContent = user;
        }
        userList.appendChild(li);
      });
      updateSendUserSelect(users);
    });

    // Handle receiving code from another user
    socket.on("receivedCode", function(data) {
      // Update the Received Code tab
      document.getElementById("receivedCodeSender").textContent = `${data.from} sent you code`;
      document.getElementById("receivedCodeContent").textContent = data.code;
      // Automatically switch to Received Code tab
      document.getElementById("tabCode").classList.remove("active");
      document.getElementById("tabOutput").classList.remove("active");
      document.getElementById("tabReceivedCode").classList.add("active");
      document.getElementById("codeTab").style.display = "none";
      document.getElementById("outputTab").style.display = "none";
      document.getElementById("receivedCodeTab").style.display = "block";
    });

    // Tab switching for Code, Output, and Received Code
    document.getElementById("tabCode").addEventListener("click", () => {
      document.getElementById("tabCode").classList.add("active");
      document.getElementById("tabOutput").classList.remove("active");
      document.getElementById("tabReceivedCode").classList.remove("active");
      document.getElementById("codeTab").style.display = "block";
      document.getElementById("outputTab").style.display = "none";
      document.getElementById("receivedCodeTab").style.display = "none";
      editor.refresh(); // Refresh CodeMirror when switching back to code
    });
    document.getElementById("tabOutput").addEventListener("click", () => {
      document.getElementById("tabOutput").classList.add("active");
      document.getElementById("tabCode").classList.remove("active");
      document.getElementById("tabReceivedCode").classList.remove("active");
      document.getElementById("codeTab").style.display = "none";
      document.getElementById("outputTab").style.display = "block";
      document.getElementById("receivedCodeTab").style.display = "none";
    });
    document.getElementById("tabReceivedCode").addEventListener("click", () => {
      document.getElementById("tabReceivedCode").classList.add("active");
      document.getElementById("tabCode").classList.remove("active");
      document.getElementById("tabOutput").classList.remove("active");
      document.getElementById("codeTab").style.display = "none";
      document.getElementById("outputTab").style.display = "none";
      document.getElementById("receivedCodeTab").style.display = "block";
    });

    // Send chat message
    function sendMessage() {
      const message = document.getElementById("messageInput").value.trim();
      if (message) {
        socket.emit("sendMessage", { username, message });
        document.getElementById("messageInput").value = "";
      }
    }

    // Display AI suggestion
    socket.on("aiSuggestion", function(suggestion) {
      alert(suggestion ? "AI Suggestion: " + suggestion : "No suggestion received.");
    });

    // Display AI-corrected code and update editor
    socket.on("aiCorrection", function(correctedCode) {
      if (correctedCode && correctedCode !== "Failed to get AI correction") {
        editor.setValue(correctedCode);
        alert("Code corrected and updated in editor.");
      } else {
        alert("AI Correction failed. Please check your API key or try again.");
      }
    });

    // Display runtime output/errors in the output section
    socket.on("runtimeErrors", function(output) {
      document.getElementById("outputSection").innerHTML = output || "No output.";
    });

    // Display chat messages
    socket.on("chatMessage", function(data) {
      const chat = document.getElementById("chat");
      const p = document.createElement("p");
      p.textContent = `${data.username}: ${data.message}`;
      chat.appendChild(p);
      chat.scrollTop = chat.scrollHeight;
    });

    // Copy button functionality for Received Code tab
    document.getElementById("copyReceivedCodeButton").addEventListener("click", function() {
      const code = document.getElementById("receivedCodeContent").textContent;
      navigator.clipboard.writeText(code).then(() => {
        const notification = document.getElementById("copyNotification");
        notification.style.opacity = 1;
        setTimeout(() => {
          notification.style.opacity = 0;
        }, 1500);
      }).catch(err => {
        console.error("Failed to copy code", err);
      });
    });
  </script>
</body>
</html>
